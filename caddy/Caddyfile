{
  email {$ADMIN_EMAIL}
  acme_ca https://acme-v02.api.letsencrypt.org/directory

  # Import Cloudflare IP rules for trusted proxy ranges
  import /etc/caddy-extra/cloudflare-ips.caddy
}

# The startup script and config library ensure DOMAIN is a clean hostname.
{$DOMAIN} {
  encode gzip zstd
  reverse_proxy vaultwarden:8080 {
    # Trust the Cloudflare proxy headers
    header_up X-Real-IP {http.request.header.CF-Connecting-IP}
  }

  log {
    output file /var/log/caddy/access.log {
      roll_size 10MB
      roll_keep 10
      roll_keep_for 2160h  # 90 days
    }
    format json
  }

  header {
    # Remove server information for security
    -Server

    # Modern security headers
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
    Referrer-Policy "strict-origin-when-cross-origin"
    # A strong Content-Security-Policy is crucial for a password manager
    Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; form-action 'self'; base-uri 'self';"
  }
}

# HTTP to HTTPS redirect
http://{$DOMAIN} {
  redir https://{host}{uri} permanent
}